<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台北天氣 Weawow 輕透版</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        :root {
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.85); /* 稍微調亮副標題，因為背景變亮了 */
            
            /* === 修改重點：調亮背景遮罩 === */
            /* 原本底部是 0.8 (太黑)，現在改為 0.5 */
            /* 頂部改為 0.1，讓天空和動畫更清楚 */
            --bg-overlay-dark: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.2) 40%, rgba(0,0,0,0.5) 100%);
            
            /* 卡片背景也稍微調淡一點點，更有空氣感 */
            --card-bg-dark: rgba(0, 0, 0, 0.25);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* 增加文字陰影，確保背景變亮後文字依然清晰 */
        body { 
            font-family: 'Roboto', sans-serif; 
            min-height: 100vh; 
            color: var(--text-primary); 
            overflow-x: hidden; 
            position: relative; 
            background-color: #333; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.4); /* 全局文字陰影加強 */
        }

        /* === 1. 背景圖片層 === */
        .bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -3;
            background-image: url('https://images.unsplash.com/photo-1568254197748-b455e220bc8c?q=80&w=1974&auto=format&fit=crop');
            background-size: cover; background-position: center; 
            /* 降低一點點亮度就好，不需要太黑 */
            filter: saturate(1.1) brightness(0.95);
            transition: opacity 0.5s ease;
        }

        /* === 2. SVG 天氣動畫層 === */
        .weather-anim-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            pointer-events: none;
            overflow: hidden;
        }
        
        .anim-group { opacity: 0; transition: opacity 1s ease; display: none; }
        .anim-group.active { opacity: 1; display: block; }

        @keyframes rotate-slow { 100% { transform: rotate(360deg); } }
        
        @keyframes rainfall {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(110vh); opacity: 0; }
        }

        @keyframes float-cloud-1 {
            0% { transform: translateX(-10%); }
            100% { transform: translateX(10%); }
        }
        @keyframes float-cloud-2 {
            0% { transform: translateX(5%); }
            100% { transform: translateX(-15%); }
        }

        @keyframes lightning-flash {
            0%, 90%, 100% { opacity: 0; }
            92% { opacity: 0.3; }
            93% { opacity: 0; }
            94% { opacity: 0.5; }
            96% { opacity: 0; }
        }

        @keyframes fog-drift {
            0% { transform: translateX(-20%); }
            100% { transform: translateX(20%); }
        }

        .sun-body { fill: rgba(255, 255, 230, 0.15); filter: blur(8px); } /* 稍微調亮太陽本體 */
        .sun-rays { animation: rotate-slow 60s linear infinite; stroke: rgba(255, 255, 255, 0.3); stroke-width: 1.5; stroke-dasharray: 5, 5; }

        .rain-drop { fill: rgba(255, 255, 255, 0.6); } /* 雨滴稍微調亮 */
        .rain-fast { animation: rainfall 1s linear infinite; }
        .rain-med { animation: rainfall 1.5s linear infinite; animation-delay: 0.5s; opacity: 0.6; }
        .rain-slow { animation: rainfall 2.5s linear infinite; animation-delay: 1s; opacity: 0.3; }

        .cloud-shape { fill: rgba(255, 255, 255, 0.2); filter: blur(15px); } /* 雲朵稍微調亮 */
        .cloud-move-1 { animation: float-cloud-1 30s ease-in-out infinite alternate; }
        .cloud-move-2 { animation: float-cloud-2 40s ease-in-out infinite alternate; }

        .lightning-overlay { fill: white; opacity: 0; animation: lightning-flash 8s infinite; }
        
        .fog-layer { fill: rgba(255, 255, 255, 0.15); filter: blur(30px); animation: fog-drift 20s linear infinite alternate; }


        /* === 3. 遮罩與 UI === */
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: var(--bg-overlay-dark); }

        .material-symbols-outlined { vertical-align: middle; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; position: sticky; top: 0; z-index: 100; }
        .location { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .update-time { font-size: 0.85rem; color: var(--text-secondary); }
        .container { padding: 20px 24px 40px; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; }
        .hero-section { text-align: center; padding: 40px 0 60px; }
        .hero-temp-group { display: flex; justify-content: center; align-items: center; margin-left: -20px; }
        .hero-icon-large { font-size: 7rem !important; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
        .hero-temp { font-size: 6.5rem; font-weight: 300; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .hero-condition { font-size: 1.8rem; font-weight: 500; margin-top: 10px; }
        .hero-details { display: flex; justify-content: center; gap: 15px; margin-top: 15px; color: var(--text-secondary); font-size: 1rem; }
        
        /* 修改 Advice Bar 邊框顏色，讓它在淺色背景下更融合 */
        .advice-bar { display: flex; justify-content: space-around; background: var(--card-bg-dark); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding: 15px; border-radius: 20px; margin-bottom: 40px; border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .advice-item { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .advice-item .material-symbols-outlined { font-size: 1.8rem; margin-bottom: 5px; }
        .advice-label { font-size: 0.8rem; color: var(--text-secondary); }
        .advice-value { font-weight: 700; }
        .section-title { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 15px; padding-left: 5px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .scroll-container { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 20px; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        
        /* 修改 Forecast Card 邊框和背景 */
        .forecast-card { min-width: 100px; background: var(--card-bg-dark); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 16px; padding: 20px 15px; text-align: center; flex-shrink: 0; scroll-snap-align: start; border: 1px solid rgba(255, 255, 255, 0.15); display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 140px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .forecast-time { font-size: 0.9rem; color: var(--text-secondary); }
        .forecast-icon { font-size: 2.5rem !important; margin: 10px 0; }
        .forecast-temp { font-size: 1.1rem; font-weight: 700; }
        .forecast-pop { font-size: 0.75rem; color: #81D4FA; display: flex; align-items: center; gap: 2px; font-weight: bold; } /* 稍微調亮降雨機率的藍色 */
        .forecast-pop .material-symbols-outlined { font-size: 0.9rem; }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #222; display: flex; justify-content: center; align-items: center; z-index: 999; transition: opacity 0.5s ease; }
        .loading-spinner { font-size: 3rem !important; animation: spin 1.5s linear infinite; color: var(--text-secondary); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div class="bg-image"></div>

    <svg class="weather-anim-layer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
        
        <g id="anim-sunny" class="anim-group">
            <g transform="translate(80, 20) scale(1.5)">
                 <circle class="sun-body" cx="0" cy="0" r="12"></circle>
                 <g class="sun-rays">
                    <line x1="0" y1="-20" x2="0" y2="-24" />
                    <line x1="14" y1="-14" x2="17" y2="-17" />
                    <line x1="20" y1="0" x2="24" y2="0" />
                    <line x1="14" y1="14" x2="17" y2="17" />
                    <line x1="0" y1="20" x2="0" y2="24" />
                    <line x1="-14" y1="14" x2="-17" y2="17" />
                    <line x1="-20" y1="0" x2="-24" y2="0" />
                    <line x1="-14" y1="-14" x2="-17" y2="-17" />
                 </g>
            </g>
        </g>

        <g id="anim-partly-cloudy" class="anim-group">
            <g transform="translate(75, 25) scale(1.0)">
                <circle class="sun-body" cx="0" cy="0" r="10"></circle>
                <g class="sun-rays">
                   <line x1="0" y1="-18" x2="0" y2="-22" />
                   <line x1="18" y1="0" x2="22" y2="0" />
                   <line x1="0" y1="18" x2="0" y2="22" />
                   <line x1="-18" y1="0" x2="-22" y2="0" />
                </g>
            </g>
            <g class="cloud-move-1" transform="translate(10, 0)">
                <path class="cloud-shape" d="M60,35 Q65,25 75,30 Q85,25 90,35 Q95,40 90,45 Q85,50 75,45 Q65,50 60,45 Q55,40 60,35 Z" />
            </g>
        </g>

        <g id="anim-cloudy" class="anim-group">
            <g class="cloud-move-1">
                <path class="cloud-shape" d="M10,20 Q20,10 35,15 Q50,5 65,15 Q80,10 90,20 Q100,30 90,40 Q80,50 65,45 Q50,50 35,45 Q20,50 10,40 Q0,30 10,20 Z" />
            </g>
            <g class="cloud-move-2" transform="translate(0, 15)">
                <path class="cloud-shape" d="M-10,30 Q10,20 30,25 Q50,15 70,25 Q90,20 110,30 Q120,40 110,50 Q90,60 70,55 Q50,60 30,55 Q10,60 -10,50 Z" opacity="0.7"/>
            </g>
        </g>

        <g id="anim-rainy" class="anim-group">
            <g class="rain-fast">
                <rect class="rain-drop" x="10" y="0" width="0.4" height="6" rx="0.2"/>
                <rect class="rain-drop" x="50" y="-10" width="0.4" height="6" rx="0.2"/>
                <rect class="rain-drop" x="90" y="-5" width="0.4" height="6" rx="0.2"/>
            </g>
            <g class="rain-med">
                <rect class="rain-drop" x="30" y="-20" width="0.3" height="5" rx="0.2"/>
                <rect class="rain-drop" x="70" y="-30" width="0.3" height="5" rx="0.2"/>
            </g>
        </g>

        <g id="anim-thunder" class="anim-group">
             <use href="#anim-rainy" />
             <rect class="lightning-overlay" x="0" y="0" width="100" height="100" />
        </g>

        <g id="anim-fog" class="anim-group">
            <rect class="fog-layer" x="-20" y="60" width="140" height="20" rx="10" />
            <rect class="fog-layer" x="-10" y="75" width="120" height="25" rx="10" style="animation-delay: -5s; opacity: 0.6;" />
        </g>

    </svg>

    <div class="bg-overlay"></div>

    <div id="loading" class="loading-screen">
        <span class="material-symbols-outlined loading-spinner">sync</span>
    </div>

    <div class="status-bar">
        <div class="location">
            <span class="material-symbols-outlined">near_me</span>
            台北市
        </div>
        <div id="updateTime" class="update-time">...</div>
    </div>

    <div class="container" id="mainContent" style="display: none; opacity: 0; transition: opacity 0.8s ease-in;">
        <div id="heroSection"></div>
        <div id="adviceSection"></div>
        <h3 class="section-title">未來預報</h3>
        <div class="scroll-container" id="futureForecasts"></div>
    </div>

    <script>
        const API_URL = "https://happy-weather.zeabur.app/api/weather/kaohsiung";

        function getWeatherIconName(weather) {
            if (!weather) return "sunny";
            if (weather.includes("雷")) return "thunderstorm";
            if (weather.includes("雨")) return "rainy";
            if (weather.includes("霧")) return "foggy";
            if (weather.includes("陰")) return "cloud";
            if (weather.includes("多雲")) return "partly_cloudy_day";
            if (weather.includes("晴")) return "wb_sunny";
            return "wb_sunny";
        }

        function getIconHtml(iconName, className = "") {
            return `<span class="material-symbols-outlined ${className}">${iconName}</span>`;
        }

        function getAdviceData(rainProb, maxTemp) {
            let rainIcon = "umbrella"; let rainText = "無需帶傘";
            if (parseInt(rainProb) >= 30) { rainText = "建議帶傘"; }
            let clothIcon = "checkroom"; let clothText = "舒適穿著";
            if (parseInt(maxTemp) >= 28) { clothIcon = "stylus_note"; clothText = "清涼短袖"; }
            else if (parseInt(maxTemp) <= 20) { clothIcon = "countertops"; clothText = "添加外套"; }
            return { rainIcon, rainText, clothIcon, clothText };
        }

        function getTimeString(startTime) {
            const date = new Date(startTime);
            return `${date.getHours().toString().padStart(2, '0')}:00`;
        }
        function getDayString(startTime) {
             const date = new Date(startTime); const today = new Date();
             return (date.getDate() === today.getDate()) ? "今天" : "明天";
        }

        function updateBackgroundAnimation(weatherText) {
            document.querySelectorAll('.anim-group').forEach(el => el.classList.remove('active'));
            
            let animId = 'anim-sunny';
            if (weatherText.includes("雷")) {
                animId = 'anim-thunder';
            } else if (weatherText.includes("雨")) {
                animId = 'anim-rainy';
            } else if (weatherText.includes("霧")) {
                animId = 'anim-fog';
            } else if (weatherText.includes("陰")) {
                animId = 'anim-cloudy';
            } else if (weatherText.includes("多雲")) {
                animId = 'anim-partly-cloudy';
            } else if (weatherText.includes("晴")) {
                animId = 'anim-sunny';
            }

            const targetAnim = document.getElementById(animId);
            if (targetAnim) {
                setTimeout(() => {
                    targetAnim.classList.add('active');
                }, 100);
            }
        }

        function renderWeather(data) {
            const forecasts = data.forecasts;
            const current = forecasts[0];
            const others = forecasts.slice(1);

            updateBackgroundAnimation(current.weather);

            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);
            const iconName = getWeatherIconName(current.weather);

            document.getElementById('heroSection').innerHTML = `
                <div class="hero-section">
                    <div class="hero-temp-group">
                        ${getIconHtml(iconName, "hero-icon-large")}
                        <div class="hero-temp">${avgTemp}°</div>
                    </div>
                    <div class="hero-condition">${current.weather}</div>
                    <div class="hero-details">
                        <span>最高 ${current.maxTemp}°</span> <span>|</span> <span>最低 ${current.minTemp}°</span>
                    </div>
                </div>
            `;

            const advice = getAdviceData(current.rain, current.maxTemp);
            document.getElementById('adviceSection').innerHTML = `
                 <div class="advice-bar">
                    <div class="advice-item">${getIconHtml("water_drop")}<span class="advice-label">降雨機率</span><span class="advice-value">${current.rain}</span></div>
                    <div class="advice-item">${getIconHtml(advice.rainIcon)}<span class="advice-label">雨具建議</span><span class="advice-value">${advice.rainText}</span></div>
                    <div class="advice-item">${getIconHtml(advice.clothIcon)}<span class="advice-label">穿搭建議</span><span class="advice-value">${advice.clothText}</span></div>
                </div>
            `;

            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';
            others.forEach(f => {
                scrollContainer.innerHTML += `
                    <div class="forecast-card">
                        <div class="forecast-time"><div>${getDayString(f.startTime)}</div><div style="font-weight:bold; margin-top:2px;">${getTimeString(f.startTime)}</div></div>
                        ${getIconHtml(getWeatherIconName(f.weather), "forecast-icon")}
                        <div><div class="forecast-temp">${Math.round((parseInt(f.maxTemp) + parseInt(f.minTemp)) / 2)}°</div>
                        <div class="forecast-pop">${getIconHtml("water_drop")} ${f.rain}</div></div>
                    </div>
                `;
            });

            const now = new Date();
            document.getElementById('updateTime').textContent = `更新於 ${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        }

        async function fetchWeather() {
            try {
                const [_, json] = await Promise.all([new Promise(r => setTimeout(r, 500)), fetch(API_URL).then(res => res.json())]);
                if (json.success) {
                    renderWeather(json.data);
                    const loading = document.getElementById('loading');
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        loading.style.display = 'none';
                        const main = document.getElementById('mainContent');
                        main.style.display = 'block';
                        requestAnimationFrame(() => { main.style.opacity = '1'; });
                    }, 500);
                } else { throw new Error("API Error"); }
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = '<p>暫時無法取得資料</p>';
            }
        }
        document.addEventListener("DOMContentLoaded", fetchWeather);
    </script>
</body>
</html>