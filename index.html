<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é–‹å¿ƒå¤©æ°£</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        :root {
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.9);
            /* èª¿æ•´é®ç½©ï¼šç¨å¾®åŠ å¼·åº•éƒ¨æ¼¸å±¤ï¼Œè®“ç™½è‰²æ–‡å­—åœ¨éƒ½å¸‚å¤œæ™¯/æ—¥æ™¯ä¸Šæ›´æ¸…æ¥š */
            --bg-overlay-dark: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.6) 100%);
            --card-bg-dark: rgba(0, 0, 0, 0.35); /* å¡ç‰‡ç¨å¾®æ·±ä¸€é»é»ï¼Œå¢åŠ å°æ¯” */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            min-height: 100vh; 
            color: var(--text-primary); 
            overflow-x: hidden; 
            position: relative; 
            background-color: #333; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* === 1. èƒŒæ™¯åœ–ç‰‡å±¤ === */
        .bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -3;
            /* ä¿®æ”¹ï¼šä½¿ç”¨æŒ‡å®šçš„ Unsplash ç…§ç‰‡ (å°åŒ— 101) */
            background-image: url('https://images.unsplash.com/photo-1609147110688-83b5fd1288e8?q=80&w=1974&auto=format&fit=crop');
            background-size: cover; background-position: center; 
            filter: saturate(1.1) brightness(0.9); /* å¾®èª¿äº®åº¦è®“æ–‡å­—æ›´æ¸…æ¥š */
            transition: opacity 0.5s ease;
        }

        /* === 2. SVG å¤©æ°£å‹•ç•«å±¤ (ä¿æŒä¸è®Š) === */
        .weather-anim-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            pointer-events: none;
            overflow: hidden;
        }
        .anim-group { opacity: 0; transition: opacity 1s ease; display: none; }
        .anim-group.active { opacity: 1; display: block; }
        @keyframes rotate-slow { 100% { transform: rotate(360deg); } }
        @keyframes rainfall { 0% { transform: translateY(-20px); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }
        @keyframes float-cloud-1 { 0% { transform: translateX(-10%); } 100% { transform: translateX(10%); } }
        @keyframes lightning-flash { 0%, 90%, 100% { opacity: 0; } 92% { opacity: 0.3; } 93% { opacity: 0; } 94% { opacity: 0.5; } 96% { opacity: 0; } }
        @keyframes fog-drift { 0% { transform: translateX(-20%); } 100% { transform: translateX(20%); } }

        .sun-body { fill: rgba(255, 255, 230, 0.15); filter: blur(8px); }
        .sun-rays { animation: rotate-slow 60s linear infinite; stroke: rgba(255, 255, 255, 0.3); stroke-width: 1.5; stroke-dasharray: 5, 5; }
        .rain-drop { fill: rgba(255, 255, 255, 0.6); }
        .rain-fast { animation: rainfall 1s linear infinite; }
        .rain-med { animation: rainfall 1.5s linear infinite; animation-delay: 0.5s; opacity: 0.6; }
        .cloud-shape { fill: rgba(255, 255, 255, 0.2); filter: blur(15px); }
        .cloud-move-1 { animation: float-cloud-1 30s ease-in-out infinite alternate; }
        .lightning-overlay { fill: white; opacity: 0; animation: lightning-flash 8s infinite; }
        .fog-layer { fill: rgba(255, 255, 255, 0.15); filter: blur(30px); animation: fog-drift 20s linear infinite alternate; }

        /* === 3. é®ç½©èˆ‡ UI === */
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: var(--bg-overlay-dark); }

        .material-symbols-outlined { vertical-align: middle; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; position: sticky; top: 0; z-index: 100; }
        .location { font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 8px; letter-spacing: 1px; }
        .update-time { font-size: 0.85rem; color: var(--text-secondary); }
        .container { padding: 20px 24px 40px; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; }
        
        /* Hero Section */
        .hero-section { text-align: center; padding: 40px 0 50px; }
        .hero-temp-group { display: flex; justify-content: center; align-items: center; margin-left: -20px; }
        .hero-icon-large { font-size: 7rem !important; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
        .hero-temp { font-size: 6.5rem; font-weight: 300; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .hero-condition { font-size: 1.8rem; font-weight: 500; margin-top: 10px; }
        .hero-details { display: flex; justify-content: center; gap: 15px; margin-top: 15px; color: var(--text-secondary); font-size: 1rem; }
        
        /* Advice Bar */
        .advice-bar { display: flex; justify-content: space-around; background: var(--card-bg-dark); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding: 15px; border-radius: 20px; margin-bottom: 40px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .advice-item { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .advice-item .material-symbols-outlined { font-size: 1.8rem; margin-bottom: 5px; }
        .advice-label { font-size: 0.8rem; color: var(--text-secondary); }
        .advice-value { font-weight: 700; font-size: 1rem; }
        
        /* Forecast Section */
        .section-title { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 15px; padding-left: 5px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        .scroll-container { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 20px; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        
        .forecast-card { min-width: 100px; background: var(--card-bg-dark); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 16px; padding: 20px 10px; text-align: center; flex-shrink: 0; scroll-snap-align: start; border: 1px solid rgba(255, 255, 255, 0.15); display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 150px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .forecast-date { font-size: 1rem; font-weight: 700; color: #FFD54F; /* ç”¨é»ƒè‰²å‡¸é¡¯æ—¥æœŸ */ margin-bottom: 2px;} 
        .forecast-time { font-size: 0.8rem; color: var(--text-secondary); }
        .forecast-icon { font-size: 2.2rem !important; margin: 8px 0; }
        .forecast-temp { font-size: 1.1rem; font-weight: 700; }
        .forecast-pop { font-size: 0.75rem; color: #81D4FA; display: flex; align-items: center; gap: 2px; font-weight: bold; }
        .forecast-pop .material-symbols-outlined { font-size: 0.9rem; }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #222; display: flex; justify-content: center; align-items: center; z-index: 999; transition: opacity 0.5s ease; }
        .loading-spinner { font-size: 3rem !important; animation: spin 1.5s linear infinite; color: var(--text-secondary); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div class="bg-image"></div>

    <svg class="weather-anim-layer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
        <g id="anim-sunny" class="anim-group"><g transform="translate(80, 20) scale(1.5)"><circle class="sun-body" cx="0" cy="0" r="12"></circle><g class="sun-rays"><line x1="0" y1="-20" x2="0" y2="-24" /><line x1="14" y1="-14" x2="17" y2="-17" /><line x1="20" y1="0" x2="24" y2="0" /><line x1="14" y1="14" x2="17" y2="17" /><line x1="0" y1="20" x2="0" y2="24" /><line x1="-14" y1="14" x2="-17" y2="17" /><line x1="-20" y1="0" x2="-24" y2="0" /><line x1="-14" y1="-14" x2="-17" y2="-17" /></g></g></g>
        <g id="anim-partly-cloudy" class="anim-group"><g transform="translate(75, 25) scale(1.0)"><circle class="sun-body" cx="0" cy="0" r="10"></circle><g class="sun-rays"><line x1="0" y1="-18" x2="0" y2="-22" /><line x1="18" y1="0" x2="22" y2="0" /><line x1="0" y1="18" x2="0" y2="22" /><line x1="-18" y1="0" x2="-22" y2="0" /></g></g><g class="cloud-move-1" transform="translate(10, 0)"><path class="cloud-shape" d="M60,35 Q65,25 75,30 Q85,25 90,35 Q95,40 90,45 Q85,50 75,45 Q65,50 60,45 Q55,40 60,35 Z" /></g></g>
        <g id="anim-cloudy" class="anim-group"><g class="cloud-move-1"><path class="cloud-shape" d="M10,20 Q20,10 35,15 Q50,5 65,15 Q80,10 90,20 Q100,30 90,40 Q80,50 65,45 Q50,50 35,45 Q20,50 10,40 Q0,30 10,20 Z" /></g></g>
        <g id="anim-rainy" class="anim-group"><g class="rain-fast"><rect class="rain-drop" x="10" y="0" width="0.4" height="6" rx="0.2"/><rect class="rain-drop" x="50" y="-10" width="0.4" height="6" rx="0.2"/><rect class="rain-drop" x="90" y="-5" width="0.4" height="6" rx="0.2"/></g><g class="rain-med"><rect class="rain-drop" x="30" y="-20" width="0.3" height="5" rx="0.2"/><rect class="rain-drop" x="70" y="-30" width="0.3" height="5" rx="0.2"/></g></g>
        <g id="anim-thunder" class="anim-group"><use href="#anim-rainy" /><rect class="lightning-overlay" x="0" y="0" width="100" height="100" /></g>
        <g id="anim-fog" class="anim-group"><rect class="fog-layer" x="-20" y="60" width="140" height="20" rx="10" /><rect class="fog-layer" x="-10" y="75" width="120" height="25" rx="10" style="animation-delay: -5s; opacity: 0.6;" /></g>
    </svg>

    <div class="bg-overlay"></div>

    <div id="loading" class="loading-screen">
        <span class="material-symbols-outlined loading-spinner">sync</span>
    </div>

    <div class="status-bar">
        <div class="location">
            <span class="material-symbols-outlined">location_on</span>
            è‡ºåŒ—å¸‚
        </div>
        <div id="updateTime" class="update-time">...</div>
    </div>

    <div class="container" id="mainContent" style="display: none; opacity: 0; transition: opacity 0.8s ease-in;">
        <div id="heroSection"></div>
        <div id="adviceSection"></div>
        <h3 class="section-title">æœªä¾† 3 å¤©å¤©æ°£é å ±</h3>
        <div class="scroll-container" id="futureForecasts"></div>
    </div>

    <script>
        // ä¿®æ”¹ï¼šAPI åœ°é»æ”¹ç‚º taipei
        const API_URL = "https://happy-weather.zeabur.app/api/weather/taipei";

        function getWeatherIconName(weather) {
            if (!weather) return "sunny";
            if (weather.includes("é›·")) return "thunderstorm";
            if (weather.includes("é›¨")) return "rainy";
            if (weather.includes("éœ§")) return "foggy";
            if (weather.includes("é™°")) return "cloud";
            if (weather.includes("å¤šé›²")) return "partly_cloudy_day";
            if (weather.includes("æ™´")) return "wb_sunny";
            return "wb_sunny";
        }

        function getIconHtml(iconName, className = "") {
            return `<span class="material-symbols-outlined ${className}">${iconName}</span>`;
        }

        // ä¿®æ”¹ï¼šæ´»æ½‘æ–‡æ¡ˆé‚è¼¯
        function getAdviceData(rainProb, maxTemp) {
            let rainIcon = "umbrella"; 
            let rainText = "æ”¾å¿ƒå‡ºé–€å•¦"; // < 30%
            if (parseInt(rainProb) >= 30) { 
                rainText = "å¸¶æŠŠå‚˜ä¿éšª"; // >= 30%
            }
            if (parseInt(rainProb) >= 70) {
                rainText = "å¿«å»æ‹¿å‚˜ï¼"; // >= 70%
            }

            let clothIcon = "checkroom"; 
            let clothText = "èˆ’æœçš„å¤©æ°£âœ¨";
            if (parseInt(maxTemp) >= 28) { 
                clothIcon = "stylus_note"; 
                clothText = "ç†±åˆ°èåŒ–ğŸ« "; 
            } else if (parseInt(maxTemp) <= 20) { 
                clothIcon = "countertops"; 
                clothText = "åŒ…æˆè‚‰ç²½å§ğŸ§¥"; 
            }

            return { rainIcon, rainText, clothIcon, clothText };
        }

        function getTimeString(startTime) {
            const date = new Date(startTime);
            const hour = date.getHours();
            // åˆ¤æ–·æ™‚æ®µè®“é¡¯ç¤ºæ›´ç›´è¦º
            let period = "ä¸Šåˆ";
            if (hour >= 12) period = "ä¸‹åˆ";
            if (hour >= 18) period = "æ™šä¸Š";
            if (hour < 6) period = "å‡Œæ™¨";
            
            return `${period} ${hour == 12 ? 12 : hour % 12}é»`;
        }

        // åˆ¤æ–·æ—¥æœŸé¡¯ç¤º (ä»Šå¤©/æ˜å¤©/é€±X)
        function getDateString(startTime) {
             const date = new Date(startTime);
             const today = new Date();
             const tomorrow = new Date(today);
             tomorrow.setDate(tomorrow.getDate() + 1);
             const dayAfter = new Date(today);
             dayAfter.setDate(dayAfter.getDate() + 2);

             if (date.getDate() === today.getDate()) {
                 return "ä»Šå¤©";
             } else if (date.getDate() === tomorrow.getDate()) {
                 return "æ˜å¤©";
             } else if (date.getDate() === dayAfter.getDate()) {
                 return "å¾Œå¤©";
             } else {
                 const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
                 return days[date.getDay()];
             }
        }

        function updateBackgroundAnimation(weatherText) {
            document.querySelectorAll('.anim-group').forEach(el => el.classList.remove('active'));
            let animId = 'anim-sunny';
            if (weatherText.includes("é›·")) animId = 'anim-thunder';
            else if (weatherText.includes("é›¨")) animId = 'anim-rainy';
            else if (weatherText.includes("éœ§")) animId = 'anim-fog';
            else if (weatherText.includes("é™°")) animId = 'anim-cloudy';
            else if (weatherText.includes("å¤šé›²")) animId = 'anim-partly-cloudy';
            else if (weatherText.includes("æ™´")) animId = 'anim-sunny';

            const targetAnim = document.getElementById(animId);
            if (targetAnim) setTimeout(() => targetAnim.classList.add('active'), 100);
        }

        function renderWeather(data) {
            const forecasts = data.forecasts;
            const current = forecasts[0];
            const others = forecasts.slice(1);

            updateBackgroundAnimation(current.weather);

            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);
            const iconName = getWeatherIconName(current.weather);

            document.getElementById('heroSection').innerHTML = `
                <div class="hero-section">
                    <div class="hero-temp-group">
                        ${getIconHtml(iconName, "hero-icon-large")}
                        <div class="hero-temp">${avgTemp}Â°</div>
                    </div>
                    <div class="hero-condition">${current.weather}</div>
                    <div class="hero-details">
                        <span>æœ€é«˜ ${current.maxTemp}Â°</span> <span>|</span> <span>æœ€ä½ ${current.minTemp}Â°</span>
                    </div>
                </div>
            `;

            const advice = getAdviceData(current.rain, current.maxTemp);
            document.getElementById('adviceSection').innerHTML = `
                 <div class="advice-bar">
                    <div class="advice-item">${getIconHtml("water_drop")}<span class="advice-label">é™é›¨ç‡</span><span class="advice-value">${current.rain}</span></div>
                    <div class="advice-item">${getIconHtml(advice.rainIcon)}<span class="advice-label">å»ºè­°</span><span class="advice-value">${advice.rainText}</span></div>
                    <div class="advice-item">${getIconHtml(advice.clothIcon)}<span class="advice-label">ç©¿æ­</span><span class="advice-value">${advice.clothText}</span></div>
                </div>
            `;

            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';
            
            // é™åˆ¶é¡¯ç¤ºçš„æ•¸é‡ï¼Œé€šå¸¸ API æœƒçµ¦å¾ˆå¤šç­†ï¼Œæˆ‘å€‘é€™è£¡é¡¯ç¤ºæœªä¾† 24-48 å°æ™‚å³å¯
            // ä¸¦åŠ ä¸Šæ¸…æ¥šçš„æ—¥æœŸæ¨™ç¤º
            others.forEach(f => {
                const dateStr = getDateString(f.startTime);
                scrollContainer.innerHTML += `
                    <div class="forecast-card">
                        <div>
                            <div class="forecast-date">${dateStr}</div>
                            <div class="forecast-time">${getTimeString(f.startTime)}</div>
                        </div>
                        ${getIconHtml(getWeatherIconName(f.weather), "forecast-icon")}
                        <div>
                            <div class="forecast-temp">${Math.round((parseInt(f.maxTemp) + parseInt(f.minTemp)) / 2)}Â°</div>
                            <div class="forecast-pop">${getIconHtml("water_drop")} ${f.rain}</div>
                        </div>
                    </div>
                `;
            });

            const now = new Date();
            document.getElementById('updateTime').textContent = `æ›´æ–° ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        }

        async function fetchWeather() {
            try {
                const [_, json] = await Promise.all([new Promise(r => setTimeout(r, 500)), fetch(API_URL).then(res => res.json())]);
                if (json.success) {
                    renderWeather(json.data);
                    const loading = document.getElementById('loading');
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        loading.style.display = 'none';
                        const main = document.getElementById('mainContent');
                        main.style.display = 'block';
                        requestAnimationFrame(() => { main.style.opacity = '1'; });
                    }, 500);
                } else { throw new Error("API Error"); }
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = '<p>æš«æ™‚ç„¡æ³•å–å¾—è³‡æ–™</p>';
            }
        }
        document.addEventListener("DOMContentLoaded", fetchWeather);
    </script>
</body>
</html>